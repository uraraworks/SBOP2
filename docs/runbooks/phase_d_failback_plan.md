# フェーズD フェイルバック手順ドラフト

本ドキュメントはフェーズDで Web 管理 UI を段階導入する際に必要となるフェイルバック方針のドラフトです。運用チームとの共同作業で内容を確定し、最終版は `docs/handovers/phase_d/shared/` に格納します。

## 1. 目的
- Web UI と MFC 版を併用する期間において、重大障害発生時に MFC 版へ切り戻す手順を明確にする。
- 切り戻し時のデータ整合性、権限設定、監査ログの保持方法を定義する。
- 運用担当者の教育計画を用意し、想定シナリオでの訓練を行えるようにする。

## 2. 適用範囲
- Wave 1 リリース後、Wave 3 完了までの併用期間。
- `/api/server`, `/api/accounts`, `/api/admin/roles` および関連 UI モジュール。
- 監査ログストレージ、フィーチャーフラグ設定、API ゲートウェイ設定。

## 3. フェイルバックトリガー
| トリガー | 判定基準 | エスカレーション先 |
| --- | --- | --- |
| 致命的 UI 障害 | Web UI で主要操作が 2 時間以上不可、または 3 件以上の重大インシデント | 運用リーダー → 開発リーダー |
| API 障害 | 管理 API の 5xx 比率が 15 分平均で 5% を超過 | サーバー担当 → プロダクトオーナー |
| 監査ログ欠損 | 操作ログが 10 分以上連続で欠落 | 運用リーダー → セキュリティ担当 |

## 4. 手順概要
1. **事前確認**
   - フィーチャーフラグで Web UI を無効化できる状態か確認（`FeatureToggle_WebAdmin`）。
   - 最新の監査ログがバックアップ済みか確認（`\\fileserver\audit\webadmin`）。
2. **Web UI 停止**
   - Web UI 配信モジュールを停止（`SboSvr` の `AdminUiModule::Disable()` 呼び出し）。
   - API エンドポイントを `503 Service Unavailable` で応答するよう設定（`ApiRouter` のフェイルモード）。
3. **MFC 版復帰**
   - 運用チームへ MFC クライアント利用再開を通知。
   - MFC 版のアカウント一覧・権限設定を最新状態と照合し、必要に応じて差分適用。
4. **監査ログ整合性確認**
   - Web UI 停止直前の監査ログをエクスポートし、MFC 側の操作ログに連番を追記。
   - 不整合があれば `AdminAuditLogger` のバックアップフォルダから再取得。
5. **復旧判断**
   - 障害原因の切り分けと修正完了報告を受けた後、ステージングで再検証。
   - QA と運用リーダーが合意し次第、フィーチャーフラグを再度有効化。

## 5. ロールと責任
| ロール | 主な責務 |
| --- | --- |
| 運用リーダー | 切り戻し判断、連絡体制の統制、監査ログ確認 |
| 開発リーダー | API/サーバー修正の指揮、テクニカルレポート作成 |
| フロント担当 | UI 停止手順の実行、再開時の確認チェックリスト更新 |
| QA | 切り戻し手順の検証、復旧後のリグレッションテスト |
| セキュリティ担当 | 監査ログ・アクセス権限の整合性チェック |

## 6. 教育・演習計画
- **机上訓練**: Wave 1 リリース前週に手順書レビューとロールプレイングを実施。
- **障害シミュレーション**: 四半期ごとに 1 回、Web UI 障害を模擬してフェイルバック→復旧を通しで実施。
- **ナレッジ更新**: 訓練結果を `docs/handovers/phase_d/shared/lessons_learned.md`（新規作成予定）に追記。

## 7. 今後の ToDo
- フィーチャーフラグの具体的な切り替え手順を `tools/scripts/` にスクリプト化する。
- 監査ログバックアップの自動化（PowerShell スクリプト）を検討。
- API 障害時に自動で通知する監視設定（Slack/Webhook）の要件を Ops チームと調整。

以上。
