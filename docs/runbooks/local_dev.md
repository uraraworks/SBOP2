# SboCli 管理者向け Web サーバー ローカル開発手順 (更新版)

本書はフェーズC PoC をローカル環境で検証するための手順です。`CHttpServer` による最小 HTTP サーバーが組み込まれたため、追加ライブラリ無しで疎通確認が可能です。

## 1. 前提条件
- Windows 10 以降
- Visual Studio 2019 以降 (C++ デスクトップ開発ワークロード)
- PowerShell 5.1 以上
- Git for Windows

## 2. リポジトリ取得
```powershell
cd C:\work
git clone git@repo.example.com:SBOP2.git
cd SBOP2
```

## 3. 設定ファイル (`SboSvr.ini`)
`SboSvr` 実行フォルダに生成される `SboSvr.ini` の `[Setting]` セクションに HTTP ポートを追記します。
```ini
[Setting]
Port=2006
HttpPort=18080   ; 必要に応じて空きポートへ変更
```
`HttpPort` を省略した場合は 18080 が既定値として利用されます。

## 4. ビルド
1. Visual Studio で `SBO.sln` を開きます。
2. 構成を `Debug | Win32` (または対象環境) に設定します。
3. `SboSvr` プロジェクトをスタートアップに設定し、ビルドします。

## 5. PoC 起動とログ
- `SboSvr` を起動すると `CHttpServer` がバックグラウンドスレッドで立ち上がり、`SboSvrLog.txt` に以下のメッセージが出力されます。
  ```
  HTTPサーバーを起動しました [Port:18080]
  ```
- アプリケーションを終了すると自動的に `HTTPサーバーを停止しました` が追記されます。

## 6. 動作確認
```powershell
# ヘルスチェック
curl http://127.0.0.1:18080/health

# ポート使用状況 (必要に応じて)
netstat -ano | findstr 18080
```
- 応答は `{"status":"ok"}` が返れば成功です。
- `SboSvrLog.txt` に起動／停止ログが残っていることを確認します。

## 7. トラブルシューティング
| 症状 | 原因 | 対策 |
| --- | --- | --- |
| `curl` がタイムアウトする | HTTP サーバースレッドが起動していない | `SboSvrLog.txt` に起動ログがあるか確認し、`SboSvr` の再起動を行う |
| ポートがバインドできない | 他プロセスが `HttpPort` を占有 | `netstat -ano | findstr <port>` で PID を特定し、ポート変更または該当プロセスを終了 |
| ログに停止メッセージが出ない | 強制終了などで `Stop()` が呼ばれていない | ウィンドウ右上の × で終了するか、`OnClose` の呼び出しで正常終了する |
| 応答が 413 になる | リクエストサイズが 8KB を超過 | PoC では大きなリクエストを受け付けない仕様。将来の制限値調整を検討 |

## 8. 今後の更新予定
- ルーティング機構および静的ファイル配信を追加した際に操作手順を追記。
- 認証導入後、資格情報設定手順を追加。
- CI/CD と連携するテストスクリプトを整備し、実行コマンドを記載。

以上。
