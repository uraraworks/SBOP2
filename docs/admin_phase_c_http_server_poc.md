# フェーズC HTTPサーバー PoC 計画

## 1. 目的
- フェーズC最初の成果物として、SboSvr プロセスに常駐する軽量 HTTP サーバーを実装し、ブラウザ／CLI から疎通できることを確認する。
- `/health` エンドポイントを通じて稼働状態を可視化し、将来の管理 API を追加しやすい拡張ポイントを用意する。
- 起動・停止・障害時のログ出力や設定ファイルによるポート変更といった運用要件を早期に検証する。

## 2. アプローチ比較と採用理由
| 候補 | メリット | デメリット | 評価 | 結論 |
| --- | --- | --- | --- | --- |
| WinSock 自前実装 (`CHttpServer`) | - 依存ライブラリが不要で既存ビルドに影響しない<br>- イベント/スレッドの制御を既存コードスタイルに合わせやすい | - ルーティングや静的配信などは自前で追加する必要がある | PoC で必要な最小機能に限定すれば開発コストが低い | **採用 (Phase C 最小構成)** |
| cpp-httplib | - ルーティング／静的配信／HTTPS などが備わっている<br>- BSD ライセンスで導入が容易 | - 追加依存（OpenSSL 等）の手配が必要<br>- 既存コードスタイルとの差分が大きい | 将来の機能拡張フェーズで再検討 | フェーズC後半で再評価 |
| Boost.Beast | - 非同期 I/O に強く高機能 | - Boost 依存が増大しビルド構成が複雑化 | 現段階では過剰 | 不採用 |

PoC では WinSock ベースの `CHttpServer` を実装し、将来的にルーティング層を切り替えられる構造（`src/Web/` 配下）とした。機能拡張が必要になった時点で `cpp-httplib` 等への置き換えを判断する。

## 3. PoC アーキテクチャ
```
+-----------------------+
| CMainFrame            |
|  - OnCreate/OnClose   |
+-----------+-----------+
            |
            v
+-----------------------+
| CHttpServer (WinSock) |
|  - Start/Stop         |
|  - Accept/HandleLoop  |
+-----------+-----------+
            |
            v
+-----------------------+
| WinSock listen socket |
+-----------------------+
```
- `CHttpServer` は専用スレッドで `WSAEventSelect` を利用して接続待ち受けを行う。停止イベント (`m_hStopEvent`) によりグレースフルに終了できる。
- `/health` で 200/JSON (`{"status":"ok"}`) を返却。リクエスト上限 8KB、メソッドは GET のみ受け付ける。
- 起動／停止結果は `SboSvrLog.txt` に「HTTPサーバーを起動しました」「HTTPサーバーを停止しました」として記録する。
- ポート番号は `SboSvr.ini` の `[Setting]` セクションに `HttpPort` を追加し、デフォルト値を `18080` とした。

## 4. 実装タスクと進捗
| ステータス | タスク | 成果物 |
| --- | --- | --- |
| ✅ | `src/Web/HttpServer.h/.cpp` を追加し、WinSock ベースの最小 HTTP サーバーを実装 | 新規コード、WinSock 初期化/イベントループ/JSON 応答 |
| ✅ | `CMainFrame` で `CHttpServer` を生成・起動・停止するフックを追加 | `MainFrame.cpp/.h` の初期化/終了処理、ログ出力 |
| ✅ | `CMgrData` に `HttpPort` 設定値を読み書きする機能を追加 | `MgrData.cpp/.h`、`SboSvr.ini` 既定値の更新 |
| ✅ | ルーティング抽象化 (`IApiHandler`/`ApiRouter`) を導入し、`/health` をハンドラ経由で提供 | `src/Web/ApiHandler.h`、`src/Web/ApiRouter.*`、`src/Web/Handlers/HealthHandler.*` |
| ⬜️ | 認証・監査・エラーハンドリング共通化 | フェーズC後半のタスク |

## 5. 検証結果と手順
1. `SboSvr.ini` に `HttpPort=18080`（任意のポート）を設定する。未設定の場合は自動的に 18080 を使用する。
2. `SBO.sln` を Debug/Win32 でビルドし、`SboSvr` を起動する。
3. PowerShell などで次を実行し、HTTP 200 応答と JSON ボディを確認する。
   ```powershell
   curl http://127.0.0.1:18080/health
   ```
4. `SboSvrLog.txt` に以下のログが出力されることを確認する。
   ```
   HTTPサーバーを起動しました [Port:18080]
   HTTPサーバーを停止しました
   ```
5. ウィンドウを閉じる、または `OnClose` を呼び出してサーバーを終了し、ポートが解放されていることを `netstat -ano | findstr 18080` で確認する。

## 6. 今後の拡張計画
- ルーティングテーブルとハンドラ登録インターフェースを `src/Web/` に追加し、REST API を段階的に実装する。（完了）
- 認証方式（Basic 認証 + IP 制限）と監査ログを PoC の結果を踏まえて設計し、共通ミドル層に組み込む。
- 静的ファイル配信やテンプレート処理を `admin_phase_c_platform.md` のマイルストーンに沿って実施する。
- CI 上で簡易 HTTP テスト (`curl` or `restcli`) を実行し、ヘルスチェックの自動検証を行う。

## 7. リスクと対策
- **ポート競合**: `HttpPort` を ini で変更可能にし、Runbook で重複検知方法を明示した。CI では 0（動的ポート）を指定する運用も検討する。
- **スレッドリーク**: `Stop()` で確実にイベントをシグナルし、`WaitForSingleObject` による待機を追加した。タイムアウト検知が必要になれば将来拡張する。
- **大きなリクエストによる DoS**: 現状 8KB 超で `413 Payload Too Large` を返す。将来は Keep-Alive 無効化やレートリミットを追加する。
- **文字コード混在**: 応答は UTF-8 固定とし、JSON で返却。将来エンコーディング要件が変わる場合はレスポンスヘッダで切り替える。

## 8. 次アクション
- ルーティング抽象化の雛形 (`IApiHandler`/`ApiRouter`) を活用し、静的ファイル配信の設計と試作を行う。
- 静的ファイル配信方式（メモリロード vs ファイルストリーム）を検討し、最小のサンプルを作成する。
- `docs/runbooks/local_dev.md` の更新手順に `HttpPort` 設定とログ確認方法を追記する（本 PR で反映）。
- CI/CD タスクの洗い出し（curl テスト、静的解析、ユニットテスト）を継続。

以上により、HTTP サーバー基盤の PoC が動作し、フェーズC後半での API 拡張に進む準備が整った。
