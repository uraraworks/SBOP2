# フェーズB アーキテクチャ設計概要

## 1. 簡易 Web サーバー構成
- **採用方針**: 既存資産との親和性と依存削減を重視し、`cpp-httplib` を静的リンクする形で採用する。
  - MIT ライセンスであり再配布制限が緩い。
  - シングルヘッダ実装のため SboCli/SboSvr のビルドシステムへの組み込みが容易。
- **配置**: SboSvr プロセスに Web サーバーモジュールを組み込み、HTTP ポートは `config/http_server.json` で設定可能とする。
- **初期機能**: `/health` ヘルスチェック、`/static/*` による静的ファイル配信、`/api/*` 以下を API ハンドラに委譲。
- **ライブラリ管理**: tools/third_party/ 以下にバージョン固定で配置し、`docs/dependency_register.md` に記載する。

## 2. SboSvr との連携方式
- **スレッドモデル**: HTTP サーバー用に専用スレッドプール（固定 4 スレッド）を確保し、SboSvr のメインループとは分離。
- **イベント連携**: API ハンドラ内では SboSvr の既存サービスクラス（例: `SboAdminService`）への同期呼び出しを行い、必要に応じて非同期ジョブキューに委譲。
- **リソース管理**: スレッド安全性のため、共有リソースは `std::shared_mutex` ベースのリードヘビー設計とし、既存の `SboLockGuard` を流用。
- **シャットダウン連携**: SboSvr 終了時に HTTP サーバーの `stop()` を呼び出し、スレッドジョイン後にプロセスを終了。

## 3. 認証・認可設計
- **認証方式**: 初期リリースでは Basic 認証 + HTTPS（リバースプロキシ経由）を必須化。将来的にトークン認証へ拡張可能な構造とする。
- **ユーザー管理**: 認証情報は `config/admin_users.yaml` で管理し、PBKDF2 によるハッシュ化済みパスワードを格納。
- **アクセス制御**: ロールを `admin`, `operator`, `viewer` の 3 段階に分け、各 API ハンドラに必要ロールをアノテーションとして付与。
- **監査ログ**: 認証成功/失敗、および管理系 API の呼び出しを `logs/admin_audit.log` に JSON 形式で記録。

## 4. API 設計方針
- **URI 設計**: `/api/v1/<resource>/<id>` 形式を基本とし、機能別に `system`, `monitor`, `operations` の 3 ドメインへ分類。
- **HTTP メソッド**: `GET` は参照、`POST` は作成/操作、`PUT` は更新、`DELETE` は削除。副作用のある操作には `POST` を利用。
- **レスポンス形式**: すべて JSON。成功レスポンスは `{ "status": "ok", "data": ... }`、エラー時は `{ "status": "error", "code": "...", "message": "..." }`。
- **API ドキュメント**: `docs/api/` 配下に OpenAPI 3.0 YAML を整備。テンプレートは `docs/api/template.yaml` に用意し、各 API タスクで複製・更新。
- **バージョニング**: 将来的な互換維持のため、URI にバージョンを含め、ヘッダ `X-SboCli-Api-Version` でのネゴシエーションを許可。

## 5. フロントエンド構成
- **構築方針**: 初期は静的 HTML + TypeScript (Vite ビルド) を選択。SPA 化が必要な画面は段階的に React へ移行可能とする。
- **配信方法**: ビルド済みアセットを `SboSvr/webroot/` に配置し、HTTP サーバーの静的ルートで配信。
- **UI コンポーネント**: `Shoelace` の Web Components を採用し、複雑なコンポーネントを自前実装せずに提供。
- **ビルドパイプライン**: `tools/webui/` にパッケージを配置し、`npm run build` で生成されたアセットを `build/webui/` に出力。CI で自動ビルドし成果物を取り込む。
- **ローカル開発**: Vite の開発サーバーを使用し、API コールは `http://localhost:8080/api` へのプロキシ設定で SboSvr に接続。

## 6. タスクと引き継ぎポイント
- **設計書レビュー**: 本文書を起点に、各セクションごとに詳細設計チケットを発行。
- **PoC**: `/health` エンドポイントと Basic 認証フローを PoC ブランチで実装し、性能測定を実施。
- **成果物**: 設計書、API テンプレート、webroot 構成図、セキュリティレビュー依頼書を次フェーズ開始前に揃える。
- **引き継ぎ**: 作業メンバーはチケット完了時に `docs/handovers/` へまとめとテスト結果を追加し、後任がフェーズ C に進められる状態を保証。
