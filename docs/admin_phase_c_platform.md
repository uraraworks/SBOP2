# フェーズC プラットフォーム基盤実装計画

## 1. フェーズのゴール
- SboSvr 内に常駐する HTTP サーバーモジュールの最小構成を実装し、ブラウザからの疎通確認が可能な状態にする。
- REST API を拡張しやすい共通基盤（ルーティング、認証、ロギング、エラーハンドリング）を提供する。
- ローカル/ステージング環境での開発・検証手順を整備し、CI/CD による自動検証を開始できる状態にする。

## 2. 実装マイルストーン
1. **HTTP サーバー最小構成の実装**
   - `CHttpServer` を SboSvr プロジェクトに組み込み、WinSock ベースの専用スレッドで待ち受ける。
   - `GET /health` が `{"status":"ok"}` を返し、ポートは `SboSvr.ini` の `HttpPort` で切り替え可能にする。
   - 停止処理で `CHttpServer::Stop()` を呼び出し、起動/停止イベントをサーバーログへ出力する。
   - 静的配信や追加ハンドラは `src/Web/` 配下で段階的に拡張し、フェーズC後半で実装する。
2. **API ハンドラ登録レイヤーの実装**
   - `IApiHandler` インターフェースを定義し、HTTP メソッド・パス・認証ロールを宣言的に記述できるようにする。（`src/Web/ApiHandler.h` として第1段階を実装済み）
   - ルーティングテーブル生成を `ApiRouter` で共通化し、起動時にハンドラを登録する仕組みを整える。（基本ルート `/health` に適用済み）
   - レスポンス共通フォーマットとエラーコード規約（`SBO-XXX`）をユーティリティとして提供。
3. **横断的コンポーネントの整備**
   - Basic 認証検証ロジックと PBKDF2 パスワード照合を `AuthProvider` に集約。
   - リクエスト/レスポンスログ、監査ログを `AdminAuditLogger` で記録し、JSON 形式に統一。
   - 例外/エラーを HTTP 応答へ変換するミドルウェア層を追加。
   - レートリミットと IP 制限を設定ファイル経由で切り替え可能にする。
4. **環境構築と自動化**
   - `docs/runbooks/local_dev.md` にローカル起動手順、ポート設定、自己署名証明書の作成方法を記載。
   - `tools/scripts/deploy_staging.ps1` を整備し、ステージング環境へのデプロイ手順を自動化。
   - GitHub Actions（もしくは既存 CI）で `cmake --build`、ユニットテスト、`npm run build` を実行するワークフローを新設。
   - API テスト用に `tests/api/healthcheck.http` を追加し、`newman` or `restcli` による自動検証を設定。

## 3. タスク分解
| カテゴリ | タスク | 出力成果物 | 担当ロール | 完了条件 |
| --- | --- | --- | --- | --- |
| HTTP サーバー | `CHttpServer` 実装、`/health` エンドポイント作成 | `SboSvr/src/Web/` 配下のソース、結合テスト | C++ 実装担当 | ローカルで curl から 200 応答を確認し、起動/停止ログを確認 |
| 静的配信 | ファイルサーブ設定、ディレクトリ構成策定 | `docs/webroot_structure.md`、設定ファイル | C++ 実装担当/フロント担当 | テスト HTML をブラウザで表示、アクセスログ取得 |
| ルーティング | `IApiHandler` と `ApiRouter` 実装 | 共通ライブラリコード、サンプルハンドラ | サーバー基盤担当 | サンプルハンドラで CRUD テスト、エラーハンドリング確認 |
| 認証・認可 | Basic 認証モジュール、ロール検証 | `AuthProvider` 実装、設定サンプル | セキュリティ担当 | 想定外ユーザー拒否、監査ログ出力、パスワードハッシュ検証 |
| ログ/監査 | `AdminAuditLogger` とローテーション設定 | ログ設定ファイル、ドキュメント | 運用担当 | 成功/失敗イベントが JSON で記録される |
| エラーハンドリング | 例外→HTTP 変換、レート制御 | エラーマップ、設定 | サーバー基盤担当 | エラーテストで適切な HTTP ステータスを返却 |
| 環境整備 | ローカル・ステージング手順書、スクリプト | `docs/runbooks/`、`tools/scripts/` | DevOps 担当 | 手順通りに環境構築し、チェックリスト完了 |
| CI/CD | ビルド・テスト・Lint ワークフロー | `.github/workflows/admin_web.yml` | DevOps 担当 | PR 時にパイプラインが自動実行される |

## 4. スケジュール案
- **Week 1**: HTTP サーバー最小実装、`/health` PoC 完了、静的配信確認。
- **Week 2**: ルーティング・API ハンドラ基盤、共通レスポンス整備、ユニットテスト作成。
- **Week 3**: 認証・認可・監査ログの導入、例外ハンドリングとレート制御の実装。
- **Week 4**: 環境構築ドキュメントとステージングデプロイスクリプト作成、CI/CD パイプライン整備。
- **Week 5**: 総合テスト、パフォーマンステスト、セキュリティレビュー準備、フェーズ D へ引き継ぎ資料作成。

## 5. 引き継ぎルール
- 各タスク完了時に `docs/handovers/phase_c/` に成果まとめ・設定値・テスト結果を記載する。
- API ハンドラ追加時は OpenAPI 定義とサーバーコードを同一 PR に含め、レビュワーが確認できるようにする。
- 認証関連の設定値（ユーザーリスト、証明書など）は `secrets/` 管理下で暗号化し、共有時は安全チャネルを利用する。
- CI/CD 設定変更は必ずサンドボックスブランチで検証し、適用手順を Runbook に追記する。

## 6. リスクと対策
- **HTTP 実装の互換性**: WinSock ベースの `CHttpServer` を継続保守しつつ、フェーズC後半で `cpp-httplib` 等への移行可否を再評価する。インターフェースを分離しておくことで差し替えを容易にする。
- **性能劣化**: ベンチマーク用シナリオを作成し、RPS・レイテンシを計測。閾値を超えた場合はスレッドプールサイズ調整や Keep-Alive 設定で対応。
- **セキュリティ脆弱性**: 静的解析（Cppcheck、clang-tidy）と依存ライブラリの脆弱性スキャンを CI に組み込み、定期レビューを実施。
- **運用負荷**: ログ肥大化を避けるためローテーション・圧縮設定を導入し、監視アラートと連携する。

## 7. 次のアクション
- [x] `cpp-httplib` のバージョン選定とライセンス確認を完了し、結果を [`docs/admin_phase_c_http_server_poc.md`](admin_phase_c_http_server_poc.md) と [`docs/licenses/cpp-httplib.md`](licenses/cpp-httplib.md) に記録する。
- [x] `CHttpServer` クラスを実装し、PoC として `/health` 応答とログ出力を確認する。
- [x] `docs/runbooks/local_dev.md` のドラフトを用意し、ローカル開発環境セットアップ手順を記載する。
- [ ] CI/CD パイプラインに追加するタスク一覧と必要なツールチェーン（CMake、Ninja、Node.js）を洗い出す。

以上の計画に沿って実装を進めることで、フェーズ D の管理機能移行作業に着手できる堅牢な基盤を整備します。
